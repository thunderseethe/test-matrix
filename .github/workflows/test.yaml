name: Build Matrix
'on':
  workflow_run:
    workflows: ["Update Crubit and Test Matrix"]
    types:
      - completed
  workflow_dispatch: null
permissions:
  actions: write
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: nightly-2026-01-28
            id: 6
          - version: nightly-2026-01-29
            id: 5
          - version: nightly-2026-01-30
            id: 4
          - version: nightly-2026-01-31
            id: 3
          - version: nightly-2026-02-01
            id: 2
          - version: nightly-2026-02-02
            id: 1
          - version: nightly-2026-02-03
            id: 0
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # submodules: true ensures the submodule folder exists to be updated
          submodules: true
          # fetch-depth: 0 ensures we have history to push back
          fetch-depth: 0
      - name: Install Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust_version }}
          components: "rust-src, rustc-dev, llvm-tools-preview"
      - name: Build Binary
        id: cargo_build
        env:
          RUSTUP_TOOLCHAIN: ${{ matrix.rust_version }}
        run: |
          cd crubit
          cargo check --bin cc_bindings_from_rs
      - name: Create Badge JSON
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COLOR="brightgreen"
          MESSAGE="passing"
          if [ "$STATUS" != "success" ]; then
            COLOR="red"
            MESSAGE="failing"
          fi
          echo "{\"schemaVersion\": 1, \"label\": \"${{ matrix.version }}\", \"message\": \"$MESSAGE\", \"color\": \"$COLOR\"}" > nightly-${{ matrix.id }}.json

      - name: Upload JSON Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: badge-${{ matrix.id }}
          path: nightly-${{ matrix.id }}.json

  upload-badges:
    needs: build
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download all JSON artifacts
        uses: actions/download-artifact@v4
        with:
          path: badges_temp
          pattern: badge-*
          merge-multiple: true

      - name: Push JSONs to badges branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git checkout 
          mv badges_temp/*.json .
          git add *.json
          if git diff --staged --quiet; then
            echo "No changes detected in matrix or submodules."
          else
            git commit -m "chore: update rust matrix and crubit submodule"
            git push
          fi
